name: dev/gitserver
on:
  push:
    paths:
      - "dev/gitserver/**"
      - ".github/workflows/dev-gitserver.yaml"
    branches:
      - dev/gitserver
jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - run: cd dev/gitserver && docker build -t thecodeisalreadydeployed/gitserver:dev .
      - run: mkdir _tmp && mkdir _ssh
      - run: |
          docker run -d \
            -p 2222:22 \
            --name gitserver \
            -v $(pwd)/_tmp/keys:/__w/keys \
            -v $(pwd)/_tmp/repos:/__w/repos \
            thecodeisalreadydeployed/gitserver:dev
      - run: |
          docker run -d \
            -p 8080:22 \
            --name gitserver-docker \
            -v $(pwd)/_tmp/keys:/git-server/keys \
            -v $(pwd)/_tmp/repos:/git-server/repos
            jkarlos/git-server-docker:latest
      - run: ssh-keygen -t ed25519 -a 100 -f $(pwd)/_ssh/id_rsa -q -N ""
      - run: ls _ssh/
      - run: sudo cp _ssh/id_rsa.pub _tmp/keys
      - id: private-key
        run: |
          echo 'PRIVATE_KEY<<EOF' >> $GITHUB_ENV
          cat _ssh/id_rsa >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
      - run: docker restart gitserver
      - run: docker restart gitserver-docker
      - run: mkdir ~/.ssh
      - run: sudo cp _ssh/id_rsa ~/.ssh/id_rsa
      - run: sudo cp dev/gitserver/.ssh/config ~/.ssh/config
      - run: |
          cd _tmp/repos
          sudo mkdir userspace
          cd userspace
          sudo git init --shared=true
          sudo touch .codedeploy
          sudo git add .codedeploy
          sudo git commit -m ".codedeploy: init"
      - run: docker logs gitserver
      - run: docker ps
      - run: docker inspect gitserver
      - run: docker exec gitserver ls /__w/keys
      - run: docker exec gitserver ls /__w/repos
      - uses: appleboy/ssh-action@master
        with:
          host: 127.0.0.1
          port: 2222
          username: git
          key: ${{ env.PRIVATE_KEY }}
          script: whoami
      - run: sudo git clone ssh://codedeploy@127.0.0.1:2222/__w/repos/userspace.git
      - run: ls
